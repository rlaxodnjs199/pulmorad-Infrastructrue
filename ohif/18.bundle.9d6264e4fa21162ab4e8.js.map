{"version":3,"sources":["webpack:////home/twkim/lamis/lamis-ohif/extensions/cornerstone/src/ConnectedCornerstoneViewport.js","webpack:////home/twkim/lamis/lamis-ohif/extensions/cornerstone/src/OHIFCornerstoneViewport.js"],"names":["OHIF","redux","actions","setViewportActive","setViewportSpecificData","measurements","MeasurementHandlers","onAdded","onRemoved","onModified","MEASUREMENT_ACTION_MAP","added","removed","modified","throttle","event","ConnectedCornerstoneViewport","connect","state","ownProps","dataFromStore","extensions","cornerstone","viewportIndex","isActive","viewports","activeViewportIndex","viewportSpecificData","isPlaying","frameRate","cine","cineFrameRate","isStackPrefetchEnabled","dispatch","data","onElementEnabled","enabledElement","detail","element","setEnabledElement","plugin","onMeasurementsChanged","action","CornerstoneViewport","StackManager","utils","OHIFCornerstoneViewport","viewportData","studies","StudyInstanceUID","displaySetInstanceUID","SOPInstanceUID","frameIndex","stack","getCornerstoneStack","console","log","clearStacks","length","Error","study","find","displaySet","displaySets","set","storedStack","findOrCreateStack","Object","assign","currentImageIdIndex","index","imageIds","findIndex","imageId","metaData","get","warn","this","props","sopClassUIDs","getViewportData","then","setState","setStateFromProps","prevProps","prevDisplaySet","childrenWithProps","children","map","child","React","cloneElement","key","imageIdIndex","onNewImage","sopInstanceUid","onNewImageDebounceTime","customProps","Component","PropTypes","object","number","node"],"mappings":"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","file":"18.bundle.9d6264e4fa21162ab4e8.js","sourcesContent":["import CornerstoneViewport from 'react-cornerstone-viewport';\nimport OHIF from '@ohif/core';\nimport { connect } from 'react-redux';\nimport throttle from 'lodash.throttle';\nimport { setEnabledElement } from './state';\n\nconst { setViewportActive, setViewportSpecificData } = OHIF.redux.actions;\nconst {\n  onAdded,\n  onRemoved,\n  onModified,\n} = OHIF.measurements.MeasurementHandlers;\n\n// TODO: Transition to enums for the action names so that we can ensure they stay up to date\n// everywhere they're used.\nconst MEASUREMENT_ACTION_MAP = {\n  added: onAdded,\n  removed: onRemoved,\n  modified: throttle(event => {\n    return onModified(event);\n  }, 300),\n};\n\nconst mapStateToProps = (state, ownProps) => {\n  let dataFromStore;\n\n  // TODO: This may not be updated anymore :thinking:\n  if (state.extensions && state.extensions.cornerstone) {\n    dataFromStore = state.extensions.cornerstone;\n  }\n\n  // If this is the active viewport, enable prefetching.\n  const { viewportIndex } = ownProps; //.viewportData;\n  const isActive = viewportIndex === state.viewports.activeViewportIndex;\n  const viewportSpecificData =\n    state.viewports.viewportSpecificData[viewportIndex] || {};\n\n  // CINE\n  let isPlaying = false;\n  let frameRate = 24;\n\n  if (viewportSpecificData && viewportSpecificData.cine) {\n    const cine = viewportSpecificData.cine;\n\n    isPlaying = cine.isPlaying === true;\n    frameRate = cine.cineFrameRate || frameRate;\n  }\n\n  return {\n    // layout: state.viewports.layout,\n    isActive,\n    // TODO: Need a cleaner and more versatile way.\n    // Currently justing using escape hatch + commands\n    // activeTool: activeButton && activeButton.command,\n    ...dataFromStore,\n    isStackPrefetchEnabled: isActive,\n    isPlaying,\n    frameRate,\n    //stack: viewportSpecificData.stack,\n    // viewport: viewportSpecificData.viewport,\n  };\n};\n\nconst mapDispatchToProps = (dispatch, ownProps) => {\n  const { viewportIndex } = ownProps;\n\n  return {\n    setViewportActive: () => {\n      dispatch(setViewportActive(viewportIndex));\n    },\n\n    setViewportSpecificData: data => {\n      dispatch(setViewportSpecificData(viewportIndex, data));\n    },\n\n    /**\n     * Our component \"enables\" the underlying dom element on \"componentDidMount\"\n     * It listens for that event, and then emits the enabledElement. We can grab\n     * a reference to it here, to make playing with cornerstone's native methods\n     * easier.\n     */\n    onElementEnabled: event => {\n      const enabledElement = event.detail.element;\n      setEnabledElement(viewportIndex, enabledElement);\n      dispatch(\n        setViewportSpecificData(viewportIndex, {\n          // TODO: Hack to make sure our plugin info is available from the outset\n          plugin: 'cornerstone',\n        })\n      );\n    },\n\n    onMeasurementsChanged: (event, action) => {\n      return MEASUREMENT_ACTION_MAP[action](event);\n    },\n  };\n};\n\nconst ConnectedCornerstoneViewport = connect(\n  mapStateToProps,\n  mapDispatchToProps\n)(CornerstoneViewport);\n\nexport default ConnectedCornerstoneViewport;\n","import React, { Component } from 'react';\n\nimport ConnectedCornerstoneViewport from './ConnectedCornerstoneViewport';\nimport OHIF from '@ohif/core';\nimport PropTypes from 'prop-types';\nimport cornerstone from 'cornerstone-core';\n\nconst { StackManager } = OHIF.utils;\n\nclass OHIFCornerstoneViewport extends Component {\n  state = {\n    viewportData: null,\n  };\n\n  static defaultProps = {\n    customProps: {},\n  };\n\n  static propTypes = {\n    studies: PropTypes.object,\n    displaySet: PropTypes.object,\n    viewportIndex: PropTypes.number,\n    children: PropTypes.node,\n    customProps: PropTypes.object,\n  };\n\n  static id = 'OHIFCornerstoneViewport';\n\n  static init() {\n    console.log('OHIFCornerstoneViewport init()');\n  }\n\n  static destroy() {\n    console.log('OHIFCornerstoneViewport destroy()');\n    StackManager.clearStacks();\n  }\n\n  /**\n   * Obtain the CornerstoneTools Stack for the specified display set.\n   *\n   * @param {Object[]} studies\n   * @param {String} StudyInstanceUID\n   * @param {String} displaySetInstanceUID\n   * @param {String} [SOPInstanceUID]\n   * @param {Number} [frameIndex=1]\n   * @return {Object} CornerstoneTools Stack\n   */\n  static getCornerstoneStack(\n    studies,\n    StudyInstanceUID,\n    displaySetInstanceUID,\n    SOPInstanceUID,\n    frameIndex = 0\n  ) {\n    if (!studies || !studies.length) {\n      throw new Error('Studies not provided.');\n    }\n\n    if (!StudyInstanceUID) {\n      throw new Error('StudyInstanceUID not provided.');\n    }\n\n    if (!displaySetInstanceUID) {\n      throw new Error('StudyInstanceUID not provided.');\n    }\n\n    // Create shortcut to displaySet\n    const study = studies.find(\n      study => study.StudyInstanceUID === StudyInstanceUID\n    );\n\n    if (!study) {\n      throw new Error('Study not found.');\n    }\n\n    const displaySet = study.displaySets.find(set => {\n      return set.displaySetInstanceUID === displaySetInstanceUID;\n    });\n\n    if (!displaySet) {\n      throw new Error('Display Set not found.');\n    }\n\n    // Get stack from Stack Manager\n    const storedStack = StackManager.findOrCreateStack(study, displaySet);\n\n    // Clone the stack here so we don't mutate it\n    const stack = Object.assign({}, storedStack);\n    stack.currentImageIdIndex = frameIndex;\n\n    if (SOPInstanceUID) {\n      const index = stack.imageIds.findIndex(imageId => {\n        const imageIdSOPInstanceUID = cornerstone.metaData.get(\n          'SOPInstanceUID',\n          imageId\n        );\n\n        return imageIdSOPInstanceUID === SOPInstanceUID;\n      });\n\n      if (index > -1) {\n        stack.currentImageIdIndex = index;\n      } else {\n        console.warn(\n          'SOPInstanceUID provided was not found in specified DisplaySet'\n        );\n      }\n    }\n\n    return stack;\n  }\n\n  getViewportData = async (\n    studies,\n    StudyInstanceUID,\n    displaySetInstanceUID,\n    SOPInstanceUID,\n    frameIndex\n  ) => {\n    let viewportData;\n\n    const stack = OHIFCornerstoneViewport.getCornerstoneStack(\n      studies,\n      StudyInstanceUID,\n      displaySetInstanceUID,\n      SOPInstanceUID,\n      frameIndex\n    );\n\n    viewportData = {\n      StudyInstanceUID,\n      displaySetInstanceUID,\n      stack,\n    };\n    return viewportData;\n  };\n\n  setStateFromProps() {\n    const { studies, displaySet } = this.props.viewportData;\n    const {\n      StudyInstanceUID,\n      displaySetInstanceUID,\n      sopClassUIDs,\n      SOPInstanceUID,\n      frameIndex,\n    } = displaySet;\n\n    if (!StudyInstanceUID || !displaySetInstanceUID) {\n      return;\n    }\n\n    if (sopClassUIDs && sopClassUIDs.length > 1) {\n      console.warn(\n        'More than one SOPClassUID in the same series is not yet supported.'\n      );\n    }\n\n    this.getViewportData(\n      studies,\n      StudyInstanceUID,\n      displaySetInstanceUID,\n      SOPInstanceUID,\n      frameIndex\n    ).then(viewportData => {\n      this.setState({\n        viewportData,\n      });\n    });\n  }\n\n  componentDidMount() {\n    this.setStateFromProps();\n  }\n\n\n  componentDidUpdate(prevProps) {\n    const { displaySet } = this.props.viewportData;\n    const prevDisplaySet = prevProps.viewportData.displaySet;\n\n    if (\n      displaySet.displaySetInstanceUID !==\n        prevDisplaySet.displaySetInstanceUID ||\n      displaySet.SOPInstanceUID !== prevDisplaySet.SOPInstanceUID ||\n      displaySet.frameIndex !== prevDisplaySet.frameIndex\n    ) {\n      this.setStateFromProps();\n    }\n  }\n\n  render() {\n    let childrenWithProps = null;\n\n    if (!this.state.viewportData) {\n      return null;\n    }\n    const { viewportIndex } = this.props;\n    const {\n      imageIds,\n      currentImageIdIndex,\n      // If this comes from the instance, would be a better default\n      // `FrameTime` in the instance\n      // frameRate = 0,\n    } = this.state.viewportData.stack;\n\n    // TODO: Does it make more sense to use Context?\n    if (this.props.children && this.props.children.length) {\n      childrenWithProps = this.props.children.map((child, index) => {\n        return (\n          child &&\n          React.cloneElement(child, {\n            viewportIndex: this.props.viewportIndex,\n            key: index,\n          })\n        );\n      });\n    }\n\n    const newImageHandler = ({ currentImageIdIndex, sopInstanceUid }) => {\n      const { displaySet } = this.props.viewportData;\n      const { StudyInstanceUID } = displaySet;\n\n      if (currentImageIdIndex > 0) {\n        this.props.onNewImage({\n          StudyInstanceUID,\n          SOPInstanceUID: sopInstanceUid,\n          frameIndex: currentImageIdIndex,\n          activeViewportIndex: viewportIndex,\n        });\n      }\n    };\n\n    return (\n      <>\n        <ConnectedCornerstoneViewport\n          viewportIndex={viewportIndex}\n          imageIds={imageIds}\n          imageIdIndex={currentImageIdIndex}\n          onNewImage={newImageHandler}\n          onNewImageDebounceTime={700}\n          // ~~ Connected (From REDUX)\n          // frameRate={frameRate}\n          // isPlaying={false}\n          // isStackPrefetchEnabled={true}\n          // onElementEnabled={() => {}}\n          // setViewportActive{() => {}}\n          {...this.props.customProps}\n        />\n        {childrenWithProps}\n      </>\n    );\n  }\n}\n\nexport default OHIFCornerstoneViewport;\n"],"sourceRoot":""}